# Multi-Agent Docker Infrastructure
# See docs/plans/2026-01-11-multi-agent-workflow-design.md for design details
#
# Usage:
#   export GITHUB_TOKEN=ghp_xxx
#   export CLAUDE_OAUTH_TOKEN=xxx
#   export GIT_REPO_URL=https://github.com/owner/repo.git
#   cd docker
#   docker compose up init        # Clone repo first
#   docker compose up agent1      # Start one agent
#   docker compose up             # Start all agents
#   docker compose --profile interactive up interactive  # Interactive mode

volumes:
  workspace:
    name: agent-workspace

services:
  # Init service: clones the repo into the shared workspace
  init:
    image: alpine:latest
    volumes:
      - workspace:/workspace
    environment:
      - GIT_REPO_URL=${GIT_REPO_URL}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    command:
      - sh
      - -c
      - |
        apk add --no-cache git
        if [ -d /workspace/main/.git ]; then
          echo "Repo already cloned, updating..."
          cd /workspace/main && git fetch origin main && git reset --hard origin/main
        else
          echo "Cloning repo..."
          if [ -n "$${GITHUB_TOKEN}" ]; then
            git clone "https://$${GITHUB_TOKEN}@$${GIT_REPO_URL#https://}" /workspace/main
          else
            git clone "$${GIT_REPO_URL}" /workspace/main
          fi
        fi
        echo "Init complete"

  # Agent template - use YAML anchors for DRY configuration
  agent1: &agent
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - workspace:/workspace
    working_dir: /workspace/main
    environment:
      - AGENT_ID=agent1
      - CLAUDE_OAUTH_TOKEN=${CLAUDE_OAUTH_TOKEN}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AGENT_MODE=${AGENT_MODE:-autonomous}
    depends_on:
      init:
        condition: service_completed_successfully
    # Safe config: no privileged access, no docker socket, no host network
    privileged: false
    network_mode: bridge
    stdin_open: true
    tty: true

  agent2:
    <<: *agent
    environment:
      - AGENT_ID=agent2
      - CLAUDE_OAUTH_TOKEN=${CLAUDE_OAUTH_TOKEN}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AGENT_MODE=${AGENT_MODE:-autonomous}

  agent3:
    <<: *agent
    environment:
      - AGENT_ID=agent3
      - CLAUDE_OAUTH_TOKEN=${CLAUDE_OAUTH_TOKEN}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AGENT_MODE=${AGENT_MODE:-autonomous}

  agent4:
    <<: *agent
    environment:
      - AGENT_ID=agent4
      - CLAUDE_OAUTH_TOKEN=${CLAUDE_OAUTH_TOKEN}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AGENT_MODE=${AGENT_MODE:-autonomous}

  # Interactive agent with port mapping for dev server access
  # Usage: docker compose --profile interactive run --service-ports interactive
  interactive:
    <<: *agent
    environment:
      - AGENT_ID=interactive
      - CLAUDE_OAUTH_TOKEN=${CLAUDE_OAUTH_TOKEN}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AGENT_MODE=interactive
    ports:
      - "5181:5173"  # Vite dev server
      - "3000:3000"  # Alt dev server
      - "8080:8080"  # API server
    profiles:
      - interactive
